<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans" xmlns:camel="http://camel.apache.org/schema/spring"
  xmlns:util="http://www.springframework.org/schema/util" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://www.springframework.org/schema/beans   http://www.springframework.org/schema/beans/spring-beans.xsd     http://camel.apache.org/schema/spring     http://camel.apache.org/schema/spring/camel-spring.xsd     http://www.springframework.org/schema/util      http://www.springframework.org/schema/util/spring-util.xsd     ">
  <bean class="com.cefriel.chimera.processor.StopProcessor" id="quit" />
  <bean class="com.cefriel.chimera.processor.AttachGraph" id="begin" />
  <bean class="com.cefriel.chimera.processor.DumpGraph" id="graphDumper" />
  <bean id="addJWT" class="com.cefriel.chimera.assetmanager.JWTHeaderAggregationStrategy" />
  <bean class="com.cefriel.chimera.processor.rdf4j.SecuredDataEnricher" id="dataEnricher">
    <property name="masterDataUrls">
      <util:list>
        <value>http://localhost:8000/publisher/media/assets_media/ontology/IT2Rail%20Ontology/it2r_onto_current.owl</value>
      </util:list>
    </property>
  </bean>
  
  
  <camelContext id="GTFS_Conversion_Context" trace="false" xmlns="http://camel.apache.org/schema/spring">
    <!-- GTFS input route -->
    <camel:route id="gtfs_route">
      <camel:from id="_from1" uri="undertow://http://0.0.0.0:8888/conversion/gtfs?httpMethodRestrict=GET" />
      <camel:log id="_log1" loggingLevel="WARN" message="GTFS conversion" />
      
      <!-- Add JWT Authentication Header from Asset Manager -->
      <camel:enrich strategyRef="addJWT">
        <camel:constant>direct:authService</camel:constant>
      </camel:enrich>

      <!-- <camel:to id="_to2" uri="direct:authService" /> -->
      <camel:process id="init_rdf" ref="begin" />
      <camel:process id="_process1" ref="dataEnricher" />
      <camel:process id="dump_graph" ref="graphDumper" />
      <camel:setBody id="_setBody2">
        <camel:constant>OK</camel:constant>
      </camel:setBody>
    </camel:route>

    <!-- Call the Asset Manager to verify/renew the token -->
    <camel:route id="renew_token">
      <camel:from id="_from2" uri="direct:authService" />
      <camel:setHeader headerName="CamelHttpMethod">
        <camel:simple>POST</camel:simple>
      </camel:setHeader>
      <camel:setHeader headerName="Content-Type" id="_setHeader1">
        <camel:constant>application/json</camel:constant>
      </camel:setHeader>
      <camel:setHeader headerName="Accept" id="_setHeader2">
        <camel:constant>application/json</camel:constant>
      </camel:setHeader>
      <camel:setBody id="_setBody1">
        <camel:constant>{ "username": "admin", "password": "dp2845unc2p8u8b"}</camel:constant>
      </camel:setBody>
      <camel:to id="_to1" uri="undertow:http://localhost:8000/api/token/" />
      <convertBodyTo id="_convertBodyTo2" type="String" />
      <camel:choice id="_choice1">
        <camel:when id="_when1">
          <camel:simple>${header.CamelHttpResponseCode} == 200</camel:simple>
          <camel:unmarshal id="_unmarshal1">
            <camel:json library="Jackson" unmarshalTypeName="com.cefriel.chimera.assetmanager.AccessResponseToken" />
          </camel:unmarshal>
          <!-- <camel:setHeader headerName="JWT_TOKEN" id="_setHeader3"> <camel:simple>${body.access}</camel:simple> </camel:setHeader> -->
        </camel:when>
      </camel:choice>
      <camel:log message="${body}"></camel:log>
    </camel:route>
  </camelContext>
</beans>
